<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Generado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="fragment/js/lib/jquery-3.2.1.min.js"></script>
    <link rel="stylesheet" href="fragment/js/lib/materialize/css/materialize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="fragment/js/lib/icomoon/style.css">


</head>
<body >
    <div id="content">
        <!--Aqui se autogenera el html dinaico-->
    </div>
    <script type="text/javascript">
        var host = 'http://192.168.3.187:8080';

        var intervalId;

        // destruye la ejecucion de los intervalos de tiempo
        var destroy = function(){
            clearInterval(intervalId);
        };

        var my_slider = function(){
            var timeExpire = 2000;
            var count = 0;

            if ($("#influence").val() === undefined || $("#influence").val() === "") return;

            var dataInfluence = JSON.parse($("#influence").val());

            console.log(dataInfluence);

            var tempInfluence = [];
            // dinamic parser
            $.each(dataInfluence,function(i,object){
                object.shown = false;
                object.image =  object.nombreima;
            });

            // buscando modulo de imagenes ya que las mismas manejan la capaciad de agregar influenciadores
            $('[type="Imagen"]').each(function(i){
                var self = $(this);
                var params = JSON.parse($( this ).attr("params"));
                if (params.isInfluencer !== undefined && params.isInfluencer === true){

                    // seteando texto a la imagen
                    //self.find("img").attr("src",(self.find("img").attr("src") === "images/office.jpg" ? "images/sample-1.jpg" : "images/office.jpg"));

                    // buscando los textos cuya target se defina en el bloque de imagen influenciador
                    $("div[type='Text']").each(function(e){
                        var paramsText = JSON.parse($( this ).attr("params"));

                        // cambiando el texto del influenciador al target del nombre de la imagen del influenciador
                        if (params.nameTarget !== undefined && paramsText.name === params.nameTarget){
                            $(this).text(params.nameInfluence);

                            // solo entra una vez
                            return false;
                        }
                    });
                }
                if(params.isSlider !== undefined && params.isSlider === true
                    && (params.isInfluencer !== undefined && params.isInfluencer === true)
                ){
                    count++;
                    // sincronizando influenciador
                    setTimeout(function(){

                        var timer = null;

                        self.mouseenter(function(){
                            clearInterval(timer);
                            timer = null
                        });

                        self.on("mouseleave",function(){
                            clearInterval(timer);
                            timer = null

                            if (timer !== null) return;
                            timer = setInterval(influencerBlockEvent,count * timeExpire);
                        });

                        var influencerBlockEvent = function(){
                            var reset = true;
                            var actualObject = {};

                            // validando si todo los influenciadores se han mostrado en el efecto slider
                            $.each(dataInfluence, function(i,object){
                                if(object.shown === false){
                                    object.shown = true;
                                    actualObject = object;
                                    reset = false;
                                    return false;
                                }
                            });

                            // reiniciando los influenciadores
                            if (reset === true) {
                                $.each(dataInfluence, function(i,object){
                                    object.shown = false;
                                    dataInfluence[i] = object;
                                });
                                actualObject = dataInfluence[0];
                            }

                            // se debe validar que el json tenga influenciadores para mostrar
                            // aqui


                            // cambiando imagenes
                            self.find("img").attr("src",actualObject.image);
                            // agrego el cambio desde el dataInfluence

                            // buscando los textos cuya target se defina en el bloque de imagen influenciador
                            $("div[type='Text']").each(function(e){
                                var paramsText = JSON.parse($( this ).attr("params"));

                                // cambiando el texto del influenciador al target del nombre de la imagen del influenciador
                                if (params.nameTarget !== undefined && paramsText.name === params.nameTarget){
                                    $(this).text("Influenciador");

                                    ///dataInfluence.show = true;
                                    return true;
                                }

                            });
                        };

                        timer = setInterval(influencerBlockEvent,count * timeExpire)
                     },count * timeExpire);
                }
          })
        };

        var buttonAction = function(){
          $("a[type='Button']").click(function(){
              var $this_element = $(this);
              var params = JSON.parse($this_element.attr("params"));

              var elementForms = [];
              var postParam={};

              try{
                  elementForms = (params.elementForm).split(',');
              } catch ( e ){
                  Materialize.toast('El boton no #target definido, por favor identifica un #target', 4000)
              }

              $.each(elementForms, function(i,value){
                  alert(value);

                  // iterando si existe el elemento seleccionado, busqueda por id
                  $("input[type='checkbox'][id='"+value+"']:checked,input[type='text'][id='"+value+"'],select#"+value).each(function(i){
                      var input = $(this);
                      eval('postParam.'+ input.attr("name") +'="'+input.val()+'"');
                  });

                  // iterando si existe elementos seleciconados typo radio por grupo
                  $("input[type='radio'][name='"+value+"']:checked").each(function(i){
                      var input = $(this);
                      eval('postParam.'+ input.attr("name") +'="'+input.val()+'"');
                  });


              });

              console.log(postParam);
              console.log("pasando por aqui");

              $.ajax({
                  url:params.action,
                  dataType: 'text',
                  data : postParam,
                  method: "POST",
                  statusCode: {
                      404: function() {
                          console.log( "page not found" );
                      }
                  }
              }).done(function( text ) {
                  // contenido de ajax aqui
              });
          });
        };

        // se reconstruye select
        var formatSelect = function(){
            $("[type='InputSelect']").each(function(i){
                var select = $(this).find("select:eq(0)");
                var labelText = $(this).find("label").text();
                var inputText = $(this).find("input");
                $(this).empty();
                $(this).append("<div class='input-field col s12'><select>"+select.html()+"</select><label>"+labelText+"</label></div>");

                $(this).find("select").material_select();
                $(this).find("input").attr("id",inputText.attr("id"));
                $(this).find("input").attr("name",inputText.attr("name"));
            });

        };

        var formatDatapicker = function(){
            $('.datepicker').pickadate({
                selectMonths: true, // Creates a dropdown to control month
                selectYears: 15, // Creates a dropdown of 15 years to control year,
                today: 'Today',
                clear: 'Clear',
                close: 'Ok',
                closeOnSelect: false, // Close upon selecting a date,
                format: 'dd/mm/yyyy',
                formatSubmit: 'yyyy/mm/dd',
            });
        };

        var elementBody =  function(){
            var $this_element = $("body:eq(0)");
            if ($("input#elementBody").attr("params") !== undefined){
                var params = JSON.parse($("input#elementBody").attr("params"));

                if (params.isBackgroundColor === true){
                    $this_element.css('background-image','none');
                    $this_element.css('background-repeat','none');
                    $this_element.css('background-position', 'none');
                    $this_element.css('background-size','none');
                    $this_element.css({"background-color":params.backgroundColor});
                } else {
                    $this_element.css({"background-color":'initial'});
                }
                if (params.isBackgroundImage === true){
                    $this_element.css('background-image',params.backgroundImage);
                    $this_element.css('background-repeat',params.backgroundRepeat);
                    $this_element.css('background-position', params.backgroundPosition);
                    $this_element.css('background-size',params.backgroundSize);
                    $this_element.css({"background-color":'initial'});
                } else {
                    $this_element.css('background-image','none');
                    $this_element.css('background-repeat','none');
                    $this_element.css('background-position', 'none');
                    $this_element.css('background-size','none');
                }
            }
        };

        var execute = function(){
            elementBody();
            my_slider();
            formatSelect();
            buttonAction();
            formatDatapicker();

        };

        jQuery(function(){
            execute();
        });
    </script>
    <div id="script">
        <script type="text/javascript">
            // script
        </script>
    </div>
    <script src="fragment/js/lib/materialize/js/materialize.min.js"></script>
</body>
</html>